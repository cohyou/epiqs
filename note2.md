# 再整理

## 概要

そもそも気づいたが、Elixir式のASTは、結局XMLと同じなのだ。
{tag-name attributes children}
ということだ。

そして、私の動機は、できるだけ、簡潔にASTを書き下せるようにすることだ。
LispやXMLのやり方は汎用的だが、冗長だ。実用に耐えうるよう、慎重にconsの種類を選んでいきたい。

また、プログラミングのためには「英語」をある程度理解する必要がある、というのも本当はいやだ。
賛否両論あるのは前提で、できるだけ、簡潔に記号だけでASTを記述できるようにしたい。

`note.md`にはそもそも、試行錯誤をそのまま書いている。
これを逆から順に辿り、改めて整理するのがこのドキュメントの目的である。


### リテラル

数値は正規表現で書くと`([1-9][0-9]*)|0`かな。
シンボルは[a-z]+ですね。アルファベットで始まっていればシンボルだとみなす。
文字列は`'` ... `'`なのか`"` ... `"`なのかは迷っている。


### 基本のcons

まずはここから。内容的には特に何もない。
表記で使用するのは`:`。中置記法のうち、唯一のプリミティブ（としたい）。


### 任意のASTへのリンクを張る

それぞれにidが振られて、それを指定したいが、どうしよう。
現在は勝手にシステムがidを振ってしまう。それを取得したい。
AST上で親が取れる？XPathの`parent`的なものを作ればよい。
もしくは`%`だけを繋いだものを作成できれば嬉しい。


### シンボル

難しいが、`{$ 基本情報 現在の値}`でしょうか、基本的には。
基本情報は`dict`、`[name:'name' type:int8]`みたいに。nameだけは必須かな。
いや、`gensym`とかだと不要か。内部的にidがついているはずなので。
値に関しては特筆する点はない。
このpiqはキレイに`{tag-name attributes children}`の形になってますね。


### 環境

シンボルテーブル、ですね。ざっくりいうと。
`{% 環境の種類 束縛変数のリスト}`
環境の種類には「変数」「関数」(Lisp-2なら)それから「モジュール」とかが浮かぶ。
だから、本来は「環境の種類」はenumであるべきだろう。

仕様として、環境のネストが気になる。`%`は新規の環境を作成する。
ただ、環境には通常親子関係が存在する。ここら辺の仕様は迷うが、
`{% [type:variable parent:~] 束縛変数のリスト}`
親の環境を明示的に指定するようにしたい（AST上では、暗黙の動きをなくしたい）。


### lambda=コードブロック

lambdaの前に、コードブロックの定義が必要かと。
`{\ 付加情報 ブロックリスト}`
付加情報には上記の環境を追加できる。あとは、実行が逐次or並行。また、返却する値も気になる。
`{\ [%:~ order:sequential #:-1] [_1]}`
引数は数値で指定。`_1`か`%1`で指定する。


### define

環境に新しく入れる、ということなので、
{%+ symbol value}
だと簡単に話は終わるのですが、どの環境なのかを明示したい気はします。
{%+ ref-env symbol:value}
ですかね。環境の種類を書くべきでしょうし、なんなら、それらをパスで指定できるようにしたいですね。
{%+ ; symbol:value} // グローバル
{%+ func symbol:value} // 関数テーブル
{%+ variable symbol:value} // 関数テーブル
{%+ type symbol:value} // 型テーブル
とかですかね。ここは少し議論の余地がありますね。

### module

上記の議論を元に、何かモジュールを表すconsが欲しくなったので、それだけ書いておきます。
もう字が余っていないのでは？`/`ぐらいかな。てか不要かなあ。
{/ }
モジュールシステムをどのように設計できるか、ということだと思います。
ネストできるのかどうか、とかも気になります。


### apply

やっと出てきたapply。
{! 関数 [arglist...]}
ですよね。これはかんたん。
と思っていたら、optionを追加できるように。
{! 関数:[option]　[arglist...]}
optionは普通、keyword-listかな。


### condition

条件分岐は
{? condition on-truthy:on-falsy}
でよいのでは。


### tuple

{& a:b {& b:c ;}}
的なやつですね。dictとkeyword-listの区別はしてもいいけど。
[a:b c:d e:f]
{a:b c:d e:f}


### deref

参照剥がしである。ポインタ剥がしのイメージで`*`をタプルから奪いました。
でもClojureっぽく、`@`でもいいかなあ。
正確には、シンボル解決である。
`{* 追加情報 symbol}`
思いつかないが、なんかあるかなあ、追加情報。


### 取得

取得には`#`を使う。
`{# 位置情報 シーケンス}`
という感じかな。何かクエリをPathとか書けたらいいなあ。
selector的な？moduleでも同じものが使えたらいいなあ。
Pythonのslice的なものは使えるつもり。


### enumはどうしよう。
`+`を使いたいので、それで。
`{+ 追加情報 [a:b c:d e:f]}`
例によって追加情報がなんなのかは思い浮かばない。


### 埋め込み
リストの埋め込みを`,`でやろう。優先順位は`:`には負けるやつ。
`{! 関数 [option]:[arglist...]}`
は
`|! func [opt1 opt2:T]:[arg1 arg2 arg3]`
いや、なんか違う。ちょっと保留。


### metadata
`{^ 追加情報 本体}`
`+>` `+<`は一旦保留。


### comment

`..`が一行、`||` ... `||`が複数行かなあ。


### exception

`!?`は発明だと思う。一番長くなるので以下のパターンか。
`{!? {ex:func ex:func func}:finally}` func}


### 非同期処理

spawnはコードブロック`\`の中で付加情報だな。非同期かどうか、待つのか、とかね。
yieldは、むしろ`|!#`かな。返却するので。

ちなみにparallelのマクロ案は`\&`。


### イベントディスパッチ

ああ、でもこれはディスパッチテーブルの話。テーブルの話は`%`かも。
そうか、`%`の環境は、シンボルテーブルだけとは限らないのか。

`|!< event-name execution-block` ..これはマクロかも。


### マクロ実行

ルールやなあ。
```
..これはちょっと簡潔すぎる？
|%+ !>
    .\ |! #> %p
```

関数なのだが、引数が何か、というのに尽きる。そこでASTを返せばいい。
でも普通に考えてPとQだけが引数。やはり、ASTをたどるXPath的なものは欲しい。

#### マクロ案

##### Lisp系(タグ)

`|` `.` `(` ... `)`の直後に来るものをXMLになぞらえてタグと呼びます。
そのタグ名と、対応する構造を返却する。Reactのコンポーネントぽいな。
でもまだこの言語には、クラスに類するものはない。
だったら、関数タイプの単純なものだけ、ということで。
それを、タグ用のテーブルに追加する、わけですね。


##### Lisp系(タグ以外)

いわゆる、ふつーの関数的なものの扱いとして、定義できる。
しかし、これって上のタグ的なものと全く同じになるよね、少なくとも。
関数扱いすることで何か変わるだろうか？
例えば、タグは表面的には引数は二つしか取れないので、もっとたくさん取りたいとか。
うーん、それってなんだか意味がない気がする。


##### XSLTぽいやつ

特定のキーワードに反応するのではなく、AST全体を見回して、クエリで書き換える部分を指定する。
この方が、まあ書き換えフィルタっぽい。両方あってもいい気もするけど。
それに、書き換えるタイミングとか、重ねがけ、も指定できる。
その代わり、本気でやるならXPath的なやつも必要になるよね。

まあ、まずは、各ASTのパース時に毎回走る関数を設定する、ということで。
それって特殊なイベントハンドラでは？

`|!! symbol [args]`というタグがきたら、`|! @symbol [args]`に変更する

```
/macro
|~ .% [ast]
   .>>>>
   |? (= |! @ast#^ !!) .. ^ はそのpiqのタグを表す
      |: <! (@ .{# P ast}) .{ast#Q}>
         ast
```

こんな感じ？でも`#`は常に働く、ということを意識しないと
さあ、quoteをどうするのか、という話

#### 必要なシンボルテーブル一覧

タグ
変数・関数
イベントディスパッチテーブル

### 実行開始

entrypointは`@@`で。
`@`がmacro開始、というのはありだと思うけど、これは後日。


### まとめ。

- 数値 `([1-9][0-9]*)|0`かな。
- シンボル [a-z]+ですね。
- 文字列 `'` ... `'` or `"` ... `"`

.. 確定
- `:` cons
- '$' symbol
- '%' environment
- `\` block
- `%+` define
- `/` module?
- `!` apply
- `?` condition
- `&` tuple
- `@` deref
- `#` slice
- `^` metadata
- `..` `||` comment
- `!?` exception
- `!#` yield （不要かも
- `!<` dispatch
- `@@` entrypoint

.. マクロかも
- `!&` parallel
- `#>` print
- `#>"` format

.. まだ策定の余地あり
- `+` enum
- `,` 埋め込み
- ASTをたどるQuery
- モジュールの具体的な仕様
